name: Cargo Build & Test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env: 
  CARGO_TERM_COLOR: always

jobs:
  build_and_test:
    name: Build & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        toolchain:
          - stable
          - beta
          - nightly
    steps:
      - uses: actions/checkout@v3
      - run: rustup update ${{ matrix.toolchain }} && rustup default ${{ matrix.toolchain }}
      - run: cargo build --verbose
      - run: cargo test --verbose
  publish:
    name: Publish to 'crates.io'
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      - uses: actions/checkout@v3
      - name: Determine Version
        id: version
        run: |
          dotnet tool install --global dotnet-semver-cli
          current_version=$(cat Cargo.toml | grep '^version =' | cut -d ' ' -f 3 | sed 's/"//g')
          new_version=$(dotnet semver -c $current_version)
          echo ::set-output name=new_version::$new_version
        shell: bash
      - run: cargo build --release
      - run: cargo package
